{% extends "dashboard/admin/base.html" %}
{% block title %}Academic Workspace{% endblock %}

{% block main %}
  <section class="page-header">
    <div>
      <h1>Academic Workspace</h1>
      <p>Manage the core academic structure and assignment flow used by all portals.</p>
    </div>
    <div class="quick-actions">
      <a class="primary-btn" href="#catalog-setup">Setup Catalog</a>
      <a class="ghost-btn" href="#teaching-flow">Teaching Flow</a>
    </div>
  </section>

  {% if flash %}
    <div class="notice notice-success">{{ flash }}</div>
  {% endif %}
  {% if flash_error %}
    <div class="notice notice-error">{{ flash_error }}</div>
  {% endif %}

  <section class="panel panel-wide" id="catalog-setup">
    <div class="panel-header">
      <h2>Catalog Setup</h2>
      <span class="panel-pill">Admin</span>
    </div>

    <p class="muted-text">Faculty -> Department -> Program -> Module</p>

    <form method="post" class="form-grid">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_faculty">
      <label class="form-field">
        Faculty Code
        <input class="input" type="text" name="code" placeholder="SCI" required>
      </label>
      <label class="form-field">
        Faculty Name
        <input class="input" type="text" name="name" placeholder="Faculty of Science" required>
      </label>
      <button class="primary-btn" type="submit">Save Faculty</button>
    </form>

    <form method="post" class="form-grid">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_department">
      <label class="form-field">
        Faculty
        <select class="input" name="faculty_id" required>
          <option value="">Choose...</option>
          {% for f in faculties %}
            <option value="{{ f.id }}">{{ f.code }} - {{ f.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="form-field">
        Department Code
        <input class="input" type="text" name="code" placeholder="CS" required>
      </label>
      <label class="form-field">
        Department Name
        <input class="input" type="text" name="name" placeholder="Computer Science" required>
      </label>
      <button class="primary-btn" type="submit">Save Department</button>
    </form>

    <form method="post" class="form-grid">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_program">
      <label class="form-field">
        Department
        <select class="input" name="department_id" required>
          <option value="">Choose...</option>
          {% for d in departments %}
            <option value="{{ d.id }}">{{ d.faculty.code }} / {{ d.code }} - {{ d.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="form-field">
        Program Code
        <input class="input" type="text" name="code" placeholder="BSC-CS" required>
      </label>
      <label class="form-field">
        Program Name
        <input class="input" type="text" name="name" placeholder="BSc Computer Science" required>
      </label>
      <label class="form-field">
        Duration (Years)
        <input class="input" type="number" min="1" name="duration_years" value="4" required>
      </label>
      <button class="primary-btn" type="submit">Save Program</button>
    </form>

    <form method="post" class="form-grid">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_module">
      <label class="form-field">
        Module Code
        <input class="input" type="text" name="code" placeholder="CSC301" required>
      </label>
      <label class="form-field">
        Module Title
        <input class="input" type="text" name="title" placeholder="Data Mining" required>
      </label>
      <label class="form-field">
        Credit Hours
        <input class="input" type="number" min="1" name="credit_hours" value="3" required>
      </label>
      <button class="primary-btn" type="submit">Save Module</button>
    </form>
  </section>

  <section class="panel panel-wide">
    <div class="panel-header">
      <h2>Session, Mapping, and Assignments</h2>
      <span class="panel-pill">Flow</span>
    </div>

    <form method="post" class="form-grid">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_session">
      <label class="form-field">
        Start Year
        <input class="input" type="number" min="2000" name="year_start" value="2026" required>
      </label>
      <label class="form-field">
        End Year
        <input class="input" type="number" min="2001" name="year_end" value="2027" required>
      </label>
      <label class="form-field">
        Semester
        <select class="input" name="semester" required>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </label>
      <label class="form-field">
        Session Name
        <input class="input" type="text" name="name" placeholder="2026/2027 - Semester 1">
      </label>
      <button class="primary-btn" type="submit">Save Session</button>
    </form>

    <form method="post" class="form-grid">
      {% csrf_token %}
      <input type="hidden" name="action" value="map_program_module">
      <label class="form-field">
        Program
        <select class="input" name="program_id" required>
          <option value="">Choose...</option>
          {% for p in programs %}
            <option value="{{ p.id }}">{{ p.code }} - {{ p.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="form-field">
        Module
        <select class="input" name="module_id" required>
          <option value="">Choose...</option>
          {% for m in modules %}
            <option value="{{ m.id }}">{{ m.code }} - {{ m.title }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="form-field">
        Semester
        <input class="input" type="number" min="1" name="semester" value="1" required>
      </label>
      <label class="form-field">
        Core Module
        <span><input type="checkbox" name="is_core" checked> Yes</span>
      </label>
      <button class="primary-btn" type="submit">Map Program Module</button>
    </form>

    <form method="post" class="form-grid" id="teaching-flow">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_teaching_assignment">
      <label class="form-field">
        Lecturer
        <select class="input" name="instructor_id" required>
          <option value="">Choose...</option>
          {% for l in lecturers %}
            <option value="{{ l.id }}">{{ l.username }}{% if l.first_name %} - {{ l.first_name }} {{ l.last_name }}{% endif %}</option>
          {% endfor %}
        </select>
      </label>
      <label class="form-field">
        Module
        <select class="input" name="module_id" required>
          <option value="">Choose...</option>
          {% for m in modules %}
            <option value="{{ m.id }}">{{ m.code }} - {{ m.title }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="form-field">
        Session
        <select class="input" name="session_id" required>
          <option value="">Choose...</option>
          {% for s in sessions %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </label>
      <button class="primary-btn" type="submit">Assign Lecturer</button>
    </form>
  </section>

  <section class="content-grid">
    <section class="panel">
      <div class="panel-header">
        <h2>Program Module Map</h2>
      </div>
      <div class="table-wrap">
        <table class="dashboard-table">
          <thead>
            <tr>
              <th>Program</th>
              <th>Module</th>
              <th>Semester</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody>
            {% for row in program_modules %}
              <tr>
                <td>{{ row.program.code }}</td>
                <td>{{ row.module.code }} - {{ row.module.title }}</td>
                <td>{{ row.semester }}</td>
                <td>{% if row.is_core %}Core{% else %}Elective{% endif %}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4">No mappings yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>Teaching Assignments</h2>
      </div>
      <div class="table-wrap">
        <table class="dashboard-table">
          <thead>
            <tr>
              <th>Lecturer</th>
              <th>Module</th>
              <th>Session</th>
              <th>Assigned</th>
            </tr>
          </thead>
          <tbody>
            {% for row in assignments %}
              <tr>
                <td>{{ row.instructor.username }}</td>
                <td>{{ row.module.code }}</td>
                <td>{{ row.session.name }}</td>
                <td>{{ row.created_at|date:"Y-m-d" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4">No teaching assignments yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </section>

  <section class="panel">
    <div class="panel-header">
      <h2>Recent Enrollments</h2>
    </div>
    <div class="table-wrap">
      <table class="dashboard-table">
        <thead>
          <tr>
            <th>Student</th>
            <th>Program</th>
            <th>Module</th>
            <th>Session</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for row in enrollments %}
            <tr>
              <td>{{ row.student.username }}</td>
              <td>{{ row.program.code|default:"-" }}</td>
              <td>{{ row.module.code }}</td>
              <td>{{ row.session.name }}</td>
              <td>{{ row.status|title }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="5">No enrollments yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}
