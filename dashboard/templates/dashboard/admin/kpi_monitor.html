{% extends "dashboard/admin/base.html" %}
{% block title %}KPI Monitor{% endblock %}

{% block main %}
  <section class="page-header">
    <div>
      <h1>KPI Monitor</h1>
      <p>Traffic-light KPIs for quick executive decisions. (Data is placeholder for now.)</p>
    </div>
    <div class="quick-actions">
      <a class="ghost-btn" href="{% url 'admin_dashboard' %}">Back to Snapshot</a>
      <a class="primary-btn" href="#">Export KPI Pack</a>
    </div>
  </section>

  <section class="kpi-meta">
    <div class="kpi-legend" aria-label="KPI legend">
      <span class="kpi-dot kpi-dot-green" aria-hidden="true"></span><span class="kpi-legend-label">On target</span>
      <span class="kpi-dot kpi-dot-yellow" aria-hidden="true"></span><span class="kpi-legend-label">Needs attention</span>
      <span class="kpi-dot kpi-dot-red" aria-hidden="true"></span><span class="kpi-legend-label">Critical</span>
    </div>
    <div class="kpi-meta-right">
      <span class="kpi-meta-pill">Admissions pending: {{ pending_applications_count }}</span>
      <span class="kpi-meta-pill">Window: Last 30 Days</span>
    </div>
  </section>

  <section class="panel" id="office-heads">
    <div class="panel-header">
      <h2>Office Heads</h2>
      <span class="panel-pill">Staff IDs</span>
    </div>

    <p class="muted-text">
      Hire or replace office leaders. Staff ID format: <code>[OfficeCode][YY]-[Sequence]</code> (example: <code>LIB24-005</code>).
    </p>

    {% if office_head_hire_error %}
      <div class="notice notice-error">{{ office_head_hire_error }}</div>
    {% endif %}

    {% if office_head_hire_result %}
      <div class="notice notice-success">
        Created staff account for <strong>{{ office_head_hire_result.full_name }}</strong> ({{ office_head_hire_result.office_code }}).
        Staff ID: <code>{{ office_head_hire_result.staff_id }}</code> Â· Password: <code>{{ office_head_hire_result.password }}</code>
      </div>
    {% endif %}

    <form method="post" class="inline-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="hire_office_head">
      <div class="form-grid">
        <label class="form-field">
          Office / Department
          <select class="input" name="office_code" required>
            {% for row in office_rows %}
              <option value="{{ row.code }}">{{ row.label }} ({{ row.code }})</option>
            {% endfor %}
          </select>
        </label>

        <label class="form-field">
          Office head full name
          <input class="input" type="text" name="full_name" required placeholder="e.g., Jane Doe">
        </label>

        <button class="primary-btn" type="submit">Hire / Generate Staff ID</button>
      </div>
    </form>

    <div class="table-wrap">
      <table class="dashboard-table">
        <thead>
          <tr>
            <th>Office</th>
            <th>Code</th>
            <th>Current Head</th>
            <th>Staff ID</th>
            <th>Assigned</th>
          </tr>
        </thead>
        <tbody>
          {% for row in office_rows %}
            <tr>
              <td>{{ row.label }}</td>
              <td>{{ row.code }}</td>
              <td>{{ row.head.full_name|default:"-" }}</td>
              <td>{{ row.head.staff_id|default:"-" }}</td>
              <td>{% if row.head %}{{ row.head.created_at|date:"Y-m-d" }}{% else %}-{% endif %}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5">No offices configured.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  {% for group in kpis %}
    <section class="panel">
      <div class="panel-header">
        <h2>{{ group.group }}</h2>
        <span class="panel-pill">KPI Set</span>
      </div>

      <div class="kpi-grid">
        {% for item in group.items %}
          <div class="kpi-card kpi-{{ item.status }}">
            <p class="kpi-label">{{ item.label }}</p>
            <p class="kpi-value">{{ item.value }}{{ item.unit }}</p>
            <p class="kpi-status">
              <span class="kpi-dot kpi-dot-{{ item.status }}" aria-hidden="true"></span>
              <span class="kpi-status-text">{{ item.status|title }}</span>
            </p>
          </div>
        {% endfor %}
      </div>
    </section>
  {% endfor %}
{% endblock %}
