{% extends "dashboard/staff/base.html" %}
{% block title %}Academic Workspace{% endblock %}

{% block main %}
  <section class="page-header">
    <div>
      <h1>Academic Workspace</h1>
      <p>{{ office_label }} operations for student programs and module enrollment workflows.</p>
    </div>
    <div class="quick-actions">
      <a class="primary-btn" href="#enrollment-tools">Enrollment Tools</a>
      <a class="ghost-btn" href="{% url 'staff_office_dashboard' office_code=office_code %}">Back to Office</a>
    </div>
  </section>

  {% if flash %}
    <div class="notice notice-success">{{ flash }}</div>
  {% endif %}
  {% if flash_error %}
    <div class="notice notice-error">{{ flash_error }}</div>
  {% endif %}

  <section class="panel panel-wide" id="enrollment-tools">
    <div class="panel-header">
      <h2>Student Program Assignment</h2>
      <span class="panel-pill">{{ office_code }}</span>
    </div>
    <form method="post" class="form-grid">
      {% csrf_token %}
      <input type="hidden" name="action" value="assign_student_program">
      <label class="form-field">
        Student
        <select class="input" name="student_id" required>
          <option value="">Choose...</option>
          {% for s in students %}
            <option value="{{ s.id }}">
              {{ s.username }} - {{ s.first_name }} {{ s.last_name }}{% if s.userprofile.program %} ({{ s.userprofile.program.code }}){% endif %}
            </option>
          {% endfor %}
        </select>
      </label>
      <label class="form-field">
        Program
        <select class="input" name="program_id" required>
          <option value="">Choose...</option>
          {% for p in programs %}
            <option value="{{ p.id }}">{{ p.code }} - {{ p.name }}</option>
          {% endfor %}
        </select>
      </label>
      <button class="primary-btn form-action-btn" type="submit">Assign Program</button>
    </form>
  </section>

  <section class="panel panel-wide">
    <div class="panel-header">
      <h2>Student Enrollment</h2>
      <span class="panel-pill">Program -> Students -> Session</span>
    </div>
    <form method="post" class="form-grid">
      {% csrf_token %}
      <input type="hidden" name="action" value="enroll_student">
      <label class="form-field">
        Student
        <select class="input" name="student_id" required>
          <option value="">Choose...</option>
          {% for s in students %}
            <option value="{{ s.id }}">{{ s.username }} - {{ s.first_name }} {{ s.last_name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="form-field">
        Module
        <select class="input" name="module_id" required>
          <option value="">Choose...</option>
          {% for m in modules %}
            <option value="{{ m.id }}">{{ m.code }} - {{ m.title }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="form-field">
        Session
        <select class="input" name="session_id" required>
          <option value="">Choose...</option>
          {% for s in sessions %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </label>
      <button class="primary-btn form-action-btn" type="submit">Save Enrollment</button>
    </form>
  </section>

  <section class="content-grid">
    <section class="panel">
      <div class="panel-header">
        <h2>Program Module Mapping</h2>
      </div>
      <div class="table-wrap">
        <table class="dashboard-table">
          <thead>
            <tr>
              <th>Program</th>
              <th>Module</th>
              <th>Semester</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody>
            {% for row in program_modules %}
              <tr>
                <td>{{ row.program.code }}</td>
                <td>{{ row.module.code }}</td>
                <td>{{ row.semester }}</td>
                <td>{% if row.is_core %}Core{% else %}Elective{% endif %}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4">No program-module mappings available.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>Enrollment Records</h2>
      </div>
      <div class="table-wrap">
        <table class="dashboard-table">
          <thead>
            <tr>
              <th>Student</th>
              <th>Program</th>
              <th>Module</th>
              <th>Session</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for row in enrollments %}
              <tr>
                <td>{{ row.student.username }}</td>
                <td>{{ row.program.code|default:"-" }}</td>
                <td>{{ row.module.code }}</td>
                <td>{{ row.session.name }}</td>
                <td>{{ row.status|title }}</td>
                <td>
                  <form method="post" class="inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="drop_enrollment">
                    <input type="hidden" name="enrollment_id" value="{{ row.id }}">
                    <button class="ghost-btn stop-access-btn" type="submit">Drop</button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6">No enrollment records found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </section>
{% endblock %}
